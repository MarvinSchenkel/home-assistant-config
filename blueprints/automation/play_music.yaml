---
blueprint:
  name: Auto play music
  description: >
    This blueprint automatically turns on media players in my 'master group',
    making sure I always have music everywhere around the house.
  domain: automation
  input:
    presence_entity:
      name: A sensor to detect presence (can be a motion sensor)
      selector:
        entity:
    target_media_player:
      name: Media player target
      description: Media player inside the master group to turn on
    no_presence_wait:
      name: Wait time
      description: Time to leave the sonos grouped after last presence is detected.
      default: 120
      selector:
        number:
          min: 1
          max: 3600
          unit_of_measurement: seconds
    custom_conditions:
      name: Custom conditions
      default: []
      description: >
        A list of custom condititions that also have to be met before turning on
        the media player

mode: restart
max_exceeded: silent

variables:
  target_media_player: !input target_media_player
  target_sonos_player: "{{ target_media_player.replace('mass_', '') }}"
  anchors:
    - &turn_on
      alias: "Turn the child media player on"
      service: media_player.turn_on
      data: {}
      target:
        entity_id: !input target_media_player

    - &turn_off
      alias: "Turn the child media player off"
      service: media_player.turn_off
      data: {}
      target:
        entity_id: !input target_media_player

    - &play_media
      alias: "Start playing music on the master group"
      service: media_player.media_play
      data: {}
      target:
        entity_id: media_player.mass_all_music_devices

    - &unmute
      alias: "Unmute main sonos entity to prevent annoying green status light"
      service: media_player.volume_mute
      data:
        is_volume_muted: false
      target:
        entity_id: "{{ target_sonos_player }}"

trigger:
  - platform: state
    entity_id: !input presence_entity
    to: "on"

  - platform: state
    entity_id: !input presence_entity
    to: "off"
    for:
      seconds: !input no_presence_wait

  - platform: homeassistant
    event: start

action:
  - choose:
      - conditions:
          - condition: state
            entity_id:
              - !input presence_entity
              - input_boolean.setting_automatic_music
            state: "on"
          - condition: and
            conditions: !input custom_conditions
        sequence:
          - if:
              - condition: state
                entity_id:
                  - !input target_media_player
                state: "off"
            then:
              - *turn_on
          - wait_template: "{{ not is_state(target_media_player, 'off') }}"
            continue_on_timeout: true
            timeout: "20"
          - if:
              - condition: not
                conditions:
                  - condition: state
                    entity_id:
                      - media_player.mass_all_music_devices
                    state: "playing"
            then:
              - *play_media

      - conditions:
          - condition: state
            entity_id:
              - !input presence_entity
            state: "off"
            for:
              seconds: !input no_presence_wait
          - not:
              - condition: state
                entity_id:
                  - !input target_media_player
                state: "off"
        sequence:
          - *turn_off
